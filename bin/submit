#!/usr/bin/ruby

require 'aip'
require 'next'

# XXX if we statically serve ARCHIVE_HOME, it is an AIP resource!!!!

def next_aip
  
  Dir.chdir(ARCHIVE_HOME) do
    n = next_in_set Dir["*"], /aip-(\d+)/
    "aip-#{n}"
  end
  
end

unless ENV['ARCHIVE_HOME'] && File.directory?(ENV['ARCHIVE_HOME'])
  puts "ARCHIVE_HOME must be set"
  exit 1
end

ARCHIVE_HOME = ENV['ARCHIVE_HOME']

if ARGV.empty?
  puts "sip path is required"
  exit 2
end

sip_path = ARGV[0]

begin
  aip = Aip.make_from_sip File.join(ARCHIVE_HOME, next_aip), sip_path  
  puts "#{aip} successfully submitted"
rescue => e
  puts e.message
  puts e.backtrace
  exit 3
end
