#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'aip'
require 'next'

def next_aip
  
  Dir.chdir(WORKSPACE) do
    n = next_in_set Dir["*"], /aip-(\d+)/
    "aip-#{n}"
  end
  
end

unless ENV['WORKSPACE'] and File.directory?(ENV['WORKSPACE'])
  puts "WORKSPACE must be set"
  exit 1
end

WORKSPACE = ENV['WORKSPACE']

if ARGV.empty?
  puts "sip is required"
  exit 2
end

sip_path = File.expand_path ARGV[0]

begin
  aip = Aip.make_from_sip File.join(WORKSPACE, next_aip), sip_path  
  puts "#{aip} successfully submitted"
rescue => e
  puts e.message
  puts e.backtrace
  exit 3
end
