#!/usr/bin/env ruby

$:.unshift '/Users/franco/Code/d2aip/lib'

require 'uuid'
require 'wip/create'
require 'template/premis'
require 'config'

CONFIG.load 'spec/config/teststack.yml'

unless ENV['WORKSPACE'] and File.directory?(ENV['WORKSPACE'])
  puts "WORKSPACE must be set to a directory"
  exit 1
end

WORKSPACE = ENV['WORKSPACE']

if ARGV.empty?
  puts "sip is required"
  exit 2
end

sip = Sip.new ARGV.shift

begin
  id = UUID.new.generate
  path = File.join WORKSPACE, id
  wip = Wip.make_from_sip path, URI.join(CONFIG['uri-prefix'], id).to_s, sip

  wip['submit-event'] = event :id => URI.join(wip.uri, 'event', 'submit').to_s, 
                              :type => 'submit', 
                              :outcome => 'success', 
                              :linking_objects => [ wip.uri ],
                              :linking_agents => [ 'info:fcla/daitss/reference-submit-client' ]

  wip['submit-agent'] = agent :id => 'info:fcla/daitss/reference-submit-client',
                              :name => 'reference implementation submit client', 
                              :type => 'software'

  puts "#{wip.uri} successfully submitted"
rescue => e
  puts e.message
  puts e.backtrace
  exit 3
end
