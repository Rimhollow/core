#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'aip'
require 'next'

def next_aip
  
  Dir.chdir(DAITSS_WORKSPACE) do
    n = next_in_set Dir["*"], /aip-(\d+)/
    "aip-#{n}"
  end
  
end

unless ENV['DAITSS_WORKSPACE'] && File.directory?(ENV['DAITSS_WORKSPACE'])
  puts "DAITSS_WORKSPACE must be set"
  exit 1
end

DAITSS_WORKSPACE = ENV['DAITSS_WORKSPACE']

if ARGV.empty?
  puts "sip is required"
  exit 2
end

sip_path = File.expand_path ARGV[0]

begin
  aip = Aip.make_from_sip File.join(DAITSS_WORKSPACE, next_aip), sip_path  
  puts "#{aip} successfully submitted"
rescue => e
  puts e.message
  puts e.backtrace
  exit 3
end
