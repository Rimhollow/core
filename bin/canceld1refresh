#!/usr/bin/env ruby

require 'rubygems'
require 'bundler/setup'
require 'logger'
require 'daitss'

include Daitss

load_archive

begin
  id = ARGV.shift or fail "package id required"

  # make sure there is a package
  p = Package.get(id) or fail "package #{id} not found"

  # make sure there is a request released
  r = p.requests.first :type => :d1refresh, :status => :released_to_workspace
  r or fail "#{id}: no d1refresh released"

  # make sure there are no wips out there
  p.stashed_wip.nil? or fail "#{id}: wip stashed in \"#{p.stashed_wip.bin.name}\""
  p.wip.nil? or fail "#{id}: wip exists"

  # cancel the req
  r.status = :cancelled
  r.save or fail "#{id} cannot cancel d1refresh"

  puts "#{id}: d1refresh cancelled"
rescue => e
  $stderr.puts "Error " + e
  exit 1
end
