#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require "config"
require 'wip'

unless ENV['WORKSPACE'] and File.directory?(ENV['WORKSPACE'])
  puts "WORKSPACE must be set"
  exit 1
end

config_file = ARGV.shift
Config::load config_file
DataMapper.setup :default, CONFIG["database"]

wip_name = ARGV.shift
wip_path = File.join WORKSPACE, wip_name

wip = begin
        Wip.new wip_path, CONFIG['uri-prefix']
      rescue => e
        puts "cannot process #{wip_name}: #{e.message}"
        exit 1
      end

wip.ingest!

# handle the aftermath
unless wip.nuked?

  if wip.tags['REJECT']?
    puts "#{wip} is rejected"
    exit 2
  elsif wip.tags['SNAFU']
    puts "#{wip} is snafu"
    exit 3
  else
    puts "#{wip} abnormally terminated"
    exit 4
  end

else
  puts "#{wip} ingested"
end
