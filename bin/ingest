#!/usr/bin/env ruby

require 'ruby-debug'
require "datamapper"
require "daitss/config"
require 'wip/ingest'
require 'rjb'
require 'workspace'

include Daitss

begin

  # configuration
  CONFIG.load_from_env
  w = Workspace.new CONFIG['workspace']
  DataMapper.setup :default, CONFIG['database-url']

  # wip
  id = ARGV.shift or raise "no wip specified"
  w[id] or raise "wip #{id} not in workspace"
  raise "no wip id specified" unless id
  wip_path = File.join w.path, id

  # ingest it
  wip = Wip.new wip_path
  wip.ingest!
  puts "#{id} ingested"
rescue => e
  puts e.message
  puts e.backtrace
  exit 1
end
