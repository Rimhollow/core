#!/usr/bin/env ruby

require 'ruby-debug'
require "datamapper"
require "daitss/config"
require 'wip/ingest'
require 'rjb'

include Daitss

begin

  # configuration
  CONFIG.load_from_env
  Workspace.new config('workspace')
  DataMapper.setup :default, config('database-url')

  # wip
  id = ARGV.shift or raise "no wip specified"
  workspace[id] or raise "wip #{id} not in workspace"
  raise "no wip id specified" unless wip_id
  wip_path = File.join workspace_dir, wip_id

  # ingest it
  wip.ingest!
  puts "#{wip.id} ingested"
  FileUtils.rm_r wip.path
rescue => e
  puts e.message
  puts e.backtrace
  exit 1
end
