#!/usr/bin/ruby

require 'aip'

raise "package url is required" if ARGV.empty?
url = ARGV[0]

aip = begin
        Aip.new url
      rescue => e
        puts "cannot process #{url}: #{e.message}"
        exit 1
      end

begin
  aip.ingest!
  puts "#{aip} ingested"
rescue Reject => e
  aip.write_reject_info e
  puts "Package #{aip} rejected"
  puts
  puts 'Reason(s) for rejection:'
  e.reasons.each { |r| puts "%s %s: %s" % [ r[:time].strftime('%c'), r[:type], r[:message] ] }
  exit 2
rescue => e
  aip.write_snafu_info e
  puts "Package #{aip} is snafu: #{e.message}"
  puts
  STDERR.puts e.backtrace
  exit 3
end
