#!/usr/bin/ruby

require 'aip'

raise "package url is required" if ARGV.empty?
url = ARGV[0]

aip = begin
        Aip.new url
      rescue => e
        puts "cannot process #{url}: #{e.message}"
        exit 1
      end

aip.extend Ingestable

begin
  aip.ingest!
rescue Reject => e
  puts "#{aip} rejected"
  
  e.reasons.each do |r|
    puts "%s %s %s" % [ r[:time], r[:type], r[:message] ]
  end

  exit 2
rescue Snafu => e
  puts "#{aip} is snafu: #{e.message}"
  exit 3
end
