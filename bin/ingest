#!/usr/bin/env ruby

require "datamapper"
require "config"
require 'wip'
require 'ingest'

wip = begin

        # workspace
        raise "WORKSPACE must be set" unless ENV['WORKSPACE']
        raise "WORKSPACE must be a directory" unless File.directory?(ENV['WORKSPACE'])

        # wip
        wip_id = ARGV.shift
        raise "no wip id specified" unless wip_id
        wip_path = File.join ENV['WORKSPACE'], wip_id
        raise "wip #{wip_id} not found in #{ENV['WORKSPACE']}" unless File.directory? wip_path

        # config file
        config_file = ARGV.shift
        raise "no config file specified" unless config_file
        CONFIG::load config_file

        # database
        DataMapper.setup :default, CONFIG["database-uri"]

        # load the wip
        Wip.new wip_path
      rescue => e
        puts "cannot process #{wip_id}: #{e.message}"
        puts e.backtrace
        exit 1
      end

wip.ingest!

if wip.tags['REJECT']
  puts "#{wip} is rejected"
  exit 2
elsif wip.tags['SNAFU']
  puts "#{wip} is snafu"
  exit 3
else
  puts "#{wip} ingested"
end

