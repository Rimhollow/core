#!/usr/bin/env ruby

require 'ruby-debug'
require "datamapper"
require "daitss/config"
require 'wip/ingest'

wip = begin

        # config
        raise "CONFIG must be set" unless ENV['CONFIG']
        Daitss::CONFIG.load ENV['CONFIG']

        # workspace
        workspace_dir = ENV['WORKSPACE'] or raise "WORKSPACE must be set"
        raise "WORKSPACE must be a directory" unless File.directory? workspace_dir

        # wip
        wip_id = ARGV.shift
        raise "no wip id specified" unless wip_id
        wip_path = File.join workspace_dir, wip_id
        raise "wip #{wip_id} not found in #{workspace_dir}" unless File.directory? wip_path

        # database
        DataMapper.setup :default, Daitss::CONFIG["database-url"]

        # load the wip
        Wip.new wip_path
      rescue => e
        puts "cannot process #{wip_id}: #{e.message}"
        puts e.backtrace
        exit 1
      end

begin
  wip.ingest!
rescue Reject => e
  sio = StringIO.new
  sio.puts Time.now
  sio.puts e.message
  wip.tags['reject'] = sio.string
  puts 'rejected'
  exit 2
rescue => e
  puts e.message
  puts e.backtrace
  exit 3
end
