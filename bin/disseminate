#!/usr/bin/env ruby

require 'ruby-debug'

require "daitss/config"
require "datamapper"
require 'wip/disseminate'

wip = begin

        # config
        raise "CONFIG must be set" unless ENV['CONFIG']
        Daitss::CONFIG.load ENV['CONFIG']

        # database
        DataMapper.setup :default, Daitss::CONFIG["database-url"]

        # workspace
        workspace_dir = ENV['WORKSPACE'] or raise "WORKSPACE must be set"
        raise "WORKSPACE must be a directory" unless File.directory? workspace_dir

        # wip
        id = ARGV.shift or raise "AIP id required"
        aip = Aip.get(id) or raise "AIP #{id} not found"
        uri = aip.uri
        path = File.join workspace_dir, id

        # load the wip
        wip = Wip.new path, uri
        wip.tags['drop-path'] = "/tmp/#{id}.tar"
        wip
      rescue => e
        puts "cannot process #{id}: #{e.message}"
        puts e.backtrace
        exit 1
      end

begin
  wip.disseminate
rescue => e
  puts e.message
  puts e.backtrace
  exit 3
end
