#!/usr/bin/env ruby
require 'bundler/setup'
require 'ruby-debug'

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require "daitss"
require 'daitss/proc/wip/d1_refresh'

include Daitss
archive
       
# Start D1 refresh on a given package 
# require a package id
id = ARGV.shift or raise "package id required"

# make the d1refresh request
package = Package.get(id)
agent = Agent.get('root')
request = Request.new(:type => :d1refresh, :is_authorized => true, :agent => agent, :package => package)

request.save or raise 'oops'
sleep 0.5 until package.wip
# create a wip for d1 refreshing on the given package
wip = package.wip

# start d1 refreshing
sleep 0.5 while wip.running?
puts wip.state