#!/usr/bin/env ruby

require 'daitss/archive'
require 'daitss/model'
require 'daitss/archive/email'

include Daitss

archive

# find all ingested packages. If it doesn't have an ingest report ops event, mail the report to the account address, and add an event for the report being mailed
STDERR.puts "Starting report daemon..."
while true
  ReportDelivery.all.each do |r|
    if r.mechanism == :email
      Archive.instance.email_report r.package
      r.package.log "ingest report mailed"
      r.destroy
    end
  end

  sleep 60
end


