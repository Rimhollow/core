#!/usr/bin/env ruby

require 'daitss'

include Daitss

INTERVAL = 1

def make_wips
  ready = Request.all :is_authorized => true, :status => :enqueued, :order => [ :timestamp.asc ]
  ready.reject! { |r| r.package.wip }
  ready.each &:dispatch
end

def start_wips
  startable = archive.workspace.reject { |w| w.running? or w.snafu? or w.stopped? }
  startable.each &:spawn
end

loop do
  make_wips
  start_wips
  sleep INTERVAL
end
