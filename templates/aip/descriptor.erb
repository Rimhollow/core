<?xml version="1.0" encoding="UTF-8"?>
<mets OBJID="<%= id %>"
      xmlns="http://www.loc.gov/METS/"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.loc.gov/METS/ http://www.loc.gov/standards/mets/mets.xsd
                          info:lc/xmlns/premis-v2 http://www.loc.gov/standards/premis/premis.xsd">
<% if metadata.has_key? 'dmd' %>
  <%= md_section metadata['dmd'], :type => 'dmdSec', :id => 'intellectual-entity-dmd' %>
<% end %>

  <amdSec>

  <!-- ieid tech -->
  <%= md_section intellectual_entity_object, :type => 'techMD', :id => 'intellectual-entity-techmd' %>
  <%= md_section representation_object(original_rep), :type => 'techMD', :id => 'representation-original-techmd' %>
  <%= md_section representation_object(current_rep), :type => 'techMD', :id => 'representation-current-techmd' %>
  <%= md_section representation_object(normalized_rep), :type => 'techMD', :id => 'representation-normalized-techmd' %>

  <!-- file tech -->
  <% datafiles.each do |df| %>
    <%= md_section df.metadata['describe-file-object'], :type => 'techMD', :id => "file-#{df.id}-description-techmd" %>
  <% end %>

  <!-- ieid digiprov (events) -->
  <%
    {
      'intellectual-entity-submit-event-digiprov' => metadata['submit-event'],
      'intellectual-entity-validation-event-digiprovi' => metadata['validate-event'],
      'intellectual-entity-ingest-event-digiprov' => metadata['ingest-event']
    }.each do |id, doc| 
  %>
    <%= md_section doc, :type => 'digiprovMD',  :id => id %>
  <% end %>

  <%#TODO the optional package level digiprov%>

  <!-- file digiprov (events) -->
  <% datafiles.each do |df| %>
    <%= md_section df.metadata['describe-event'], :type => 'digiprovMD', :id => "file-#{df.id}-describe-event-digiprov" %>
    <%= md_section df.metadata['migrate-event'], :type => 'digiprovMD', :id => "file-#{df.id}-migrate-event-digiprov" if df.metadata['migrate-event'] %>
    <%= md_section df.metadata['normalize-event'], :type => 'digiprovMD', :id => "file-#{df.id}-normalize-event-digiprov" if df.metadata['normalize-event'] %>
  <% end %>

  <!-- ieid digiprov (agents) -->
  <% # TODO make the agents for the package %>

  <!-- file digiprov (agents) -->
  <% datafiles.each do |df| %>
    <%= md_section df.metadata['describe-agent'], :type=> 'digiprovMD', :id => "file-#{df.id}-describe-agent-digiprov" %>
    <%= md_section df.metadata['migrate-agent'], :type=> 'digiprovMD', :id => "file-#{df.id}-migrate-agent-digiprov" if df.metadata['migrate-agent'] %>
    <%= md_section df.metadata['normalize-agent'], :type=> 'digiprovMD', :id => "file-#{df.id}-normalize-agent-digiprov" if df.metadata['normalize-agent'] %>
  <% end %>
  </amdSec>
	
  <fileSec>
    <fileGrp>
    <% datafiles.each do |df| %>
      <%= file_element df %>
    <% end %>
    </fileGrp>
  </fileSec>

  <%= representation_struct_map original_rep, :id => 'representation-original', :admid => 'representation-original-techmd' %>
  <%= representation_struct_map current_rep, :id => 'representation-current', :admid => 'representation-current-techmd' %>
  <%= representation_struct_map normalized_rep, :id => 'representation-normalized', :admid => 'representation-normalized-techmd' %>
</mets>
