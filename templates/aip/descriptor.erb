<?xml version="1.0" encoding="UTF-8"?>
<mets OBJID="<%= uri %>"
      xmlns="http://www.loc.gov/METS/"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.loc.gov/METS/ http://www.loc.gov/standards/mets/mets.xsd
                          info:lc/xmlns/premis-v2 http://www.loc.gov/standards/premis/premis.xsd">
<% if metadata.has_key? 'dmd' %>
  <%= md_section metadata['dmd'], :type => 'dmdSec', :id => 'intellectual-entity-dmd' %>
<% end %>

  <amdSec>

  <!-- ieid tech -->
  <%= md_section intellectual_entity_object, :type => 'techMD', :id => 'intellectual-entity-techmd' %>

  <%
    { 'original' => original_rep, 'current' => current_rep, 'normalized' => normalized_rep }.each do |name, rep|
      mets_id = "representation-#{name}-techmd"
      rep_uri = "#{uri}/representation/#{name}"
      rep_object = representation_object rep, :uri => rep_uri
    %>
    <%=  md_section rep_object, :type => 'techMD', :id => mets_id %>
  <% end %>

  <!-- file tech -->
  <% datafiles.each do |df| %>
    <%= md_section df['describe-file-object'], :type => 'techMD', :id => "file-#{df.id}-description-techmd" %>

    <% if df.has_key? 'describe-bitstream-objects' %>
      <% bs_objects = df['describe-bitstream-objects'].split %r{\n(?=<event)} %>
      <% bs_objects.each_with_index do |bs_object, index| %>
        <%= md_section bs_object, :type => 'techMD', :id => "file-#{df.id}-bs-#{index}-techmd" %>
      <% end %>
    <% end %>

  <% end %>

  <!-- ieid digiprov (events) -->
  <%
    ieid_digiprov = {
      'intellectual-entity-submit-event-digiprov' => metadata['submit-event'],
      'intellectual-entity-validation-event-digiprov' => metadata['validate-event'],
      'intellectual-entity-ingest-event-digiprov' => metadata['ingest-event']
    }

    # optional digiprov
    if metadata.has_key? 'disseminate-event'
      ieid_digiprov['intellectual-entity-disseminate-event-digiprov'] = metadata['disseminate-event']
    end

    ieid_digiprov.each do |id, doc| 
  %>
  <%= md_section doc, :type => 'digiprovMD',  :id => id %>
<% end %>

<!-- file digiprov (events) -->
<% datafiles.each do |df| %>
  <%= md_section df.metadata['describe-event'], :type => 'digiprovMD', :id => "file-#{df.id}-describe-event-digiprov" %>
  <%= md_section df.metadata['migrate-event'], :type => 'digiprovMD', :id => "file-#{df.id}-migrate-event-digiprov" if df.metadata['migrate-event'] %>
  <%= md_section df.metadata['normalize-event'], :type => 'digiprovMD', :id => "file-#{df.id}-normalize-event-digiprov" if df.metadata['normalize-event'] %>
<% end %>

<!-- ieid digiprov (agents) -->
<% # TODO make the agents for the package %>

<!-- file digiprov (agents) -->
<% datafiles.each do |df| %>
  <%= md_section df.metadata['describe-agent'], :type=> 'digiprovMD', :id => "file-#{df.id}-describe-agent-digiprov" %>
  <%= md_section df.metadata['migrate-agent'], :type=> 'digiprovMD', :id => "file-#{df.id}-migrate-agent-digiprov" if df.metadata['migrate-agent'] %>
  <%= md_section df.metadata['normalize-agent'], :type=> 'digiprovMD', :id => "file-#{df.id}-normalize-agent-digiprov" if df.metadata['normalize-agent'] %>
<% end %>
</amdSec>

<fileSec>
<fileGrp>
<% datafiles.each do |df| %>
  <%= file_element df %>
<% end %>
</fileGrp>
</fileSec>

<%= representation_struct_map original_rep, :id => 'original', :admid => 'representation-original-techmd' %>
<%= representation_struct_map current_rep, :id => 'current', :admid => 'representation-current-techmd' %>
<%= representation_struct_map normalized_rep, :id => 'normalized', :admid => 'representation-normalized-techmd' %>
</mets>
