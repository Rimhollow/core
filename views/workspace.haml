= partial :"wip-scope-table", :locals => { :params => @params, :action => "/workspace"}
%hr/

%h1
  update jobs

#update-form

  %form{:action => '/workspace', :method => 'post'}
    - if @params['filter']
      %input{:name => 'filter', :type => 'hidden', :value => 'true'}
      - @wips.each do |w|
        %input{:name => 'wips[]', :type => 'hidden', :value => w.id}
        
    %input#state-start{:type => 'radio', :name => 'task', :value => 'start'}
    %label{:for => 'state-start'} start

    %input#state-stop{:type => 'radio', :name => 'task', :value => 'stop'}
    %label{:for => 'state-stop'} stop

    %input#state-unsnafu{:type => 'radio', :name => 'task', :value => 'unsnafu'}
    %label{:for => 'state-unsnafu'} reset

    %input#state-doover{:type => 'radio', :name => 'task', :value => 'doover'}
    %label{:for => 'state-doover'} do over

    %input#state-stash{:type => 'radio', :name => 'task', :value => 'stash'}
    %label{:for => 'state-stash'} stash

    %select{:name => 'stash-bin'}
      - @bins.each do |bin|
        %option= bin.name

    %textarea#note{:name => 'note'}
    %label{:for => 'note'}

    %input{:type => 'submit', :value => "Update"}

%hr/

- idle_wips = @wips.find_all { |w| w.state == :idle }

#idles
  
  %h2
    idle jobs: 
    = idle_wips.length

  - ingest_count = idle_wips.find_all { |w| w.task == :ingest }.length
  - d1refresh_count = idle_wips.find_all { |w| w.task == :d1refresh }.length
  - disseminate_count = idle_wips.find_all { |w| w.task == :disseminate }.length
  - withdraw_count = idle_wips.find_all { |w| w.task == :withdraw }.length
  - peek_count = idle_wips.find_all { |w| w.task == :peek }.length

  %table
    %tr
      %th
        task
      %th
        count
    %tr
      %td
        ingest
      %td= ingest_count
    %tr
      %td
        d1refresh
      %td= d1refresh_count
    %tr
      %td
        disseminate
      %td= disseminate_count
    %tr
      %td
        withdraw
      %td= withdraw_count

- @wips = @wips - idle_wips

#results
  %h2
    active jobs: 
    = @wips.size

  %h3
    running:
    = archive.workspace.select(&:running?).size
    &nbsp;
    throttles:
    &nbsp;
    = throttles(:ingest)
    &nbsp;
    = throttles(:dissemination)
    &nbsp;
    = throttles(:withdrawal)
    &nbsp;
    = throttles(:d1refresh)

    - unless @wips.empty?
      = partial :wip_table, :locals => { :wips => @wips  }
